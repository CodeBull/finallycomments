<!doctype html>

<html>
  <head>
  <meta charset="utf8">
  <style>
    @import url('https://fonts.googleapis.com/css?family=Sanchez');
    * {
      box-sizing: border-box;
    }
    .sc-section {
      font-family: 'Sanchez', serif;
    }
    .sc-comments {
      padding: 15px 0;
      border: solid 1px #ccc;
    }
    .sc-topbar__rule {
      border: none;
      border: solid 2px #ccc;
    }
    .sc-topbar {
      position: relative;

      margin-top: 25px;
    }
    .sc-topbar__upvote {
      display: inline-block;
      margin: 0 20px 10px 0;
      cursor: pointer;
      background: #7f8db1;
      border-radius: 5px;
      color: #fff;
      box-shadow: 0 0 15px rgba(0,0,0,0.15);
      padding: 5px 10px;
    }
    .sc-topbar__reply {
      display: inline-block;
      margin: 0 20px 10px 0;
      cursor: pointer;
      background: #7f8db1;
      border-radius: 5px;
      color: #fff;
      box-shadow: 0 0 15px rgba(0,0,0,0.15);
      padding: 5px 10px;
    }
    .sc-close {
      position: absolute;
      top: 5px;
      right: 10px;
      transform: rotate(45deg);
      font-size: 40px;
      line-height: 1;
      cursor: pointer;
    }
    .comment {
      padding: 0 15px 10px;
    }
    .comment-level-1 {
      /*border: solid 1px #4f79ff;*/
    }
    .comment-level-2 {
      /*border: solid 1px green;*/
      margin-left: 20px;
      /*padding: 0 15px 15px*/
    }
    img {
      border-radius: 50%;
      border: solid 2px #ccc;
    }


    .modal__inner__comment {
      width: 100%;
      padding: 15px 0;
      position: relative;
    }
    .sc-comment__username {
    }

    .sc-comment__message {
      width: 100%;
      margin-bottom: 20px;
      border: solid 1px #333;
    }

    .sc-comment__btn {
      display: inline-block;
      margin: 0 20px 10px 0;
      cursor: pointer;
      background: #7f8db1;
      border-radius: 5px;
      color: #fff;
      box-shadow: 0 0 15px rgba(0,0,0,0.15);
      padding: 5px 10px;
      text-decoration: none;
    }

    .sc-vote {
      position: absolute;
      padding: 20px;
      background-color: #fff;
      max-width: 300px;
      border-radius: 3px;
      box-shadow: 0 0 25px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .sc-vote__close {
      bottom: 15px;
      top: auto;
      font-size: 50px;
    }
    .sc-vote__username {
      width: 100%;
      margin-bottom: 15px;
      border-radius: 5px;
      text-align: center;
      border: none;
      border: solid 1px #ccc;
      padding: 10px;
    }
    .sc-vote__username:focus {
      outline: none;
    }
    .sc-vote__value {
      display: inline-block;
      width: 50px;
      text-align: center;
    }
    .sc-vote__slider {
      width: 150px;

    }

    input[type=range] {
      -webkit-appearance: none;
      margin: 10px 0;
    }
    input[type=range]:focus {
      outline: none;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 10px;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      background: #ccc;
      border-radius: 25px;
      border: 0px solid #fafafa;
    }
    input[type=range]::-webkit-slider-thumb {
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      border: 0px solid #000000;
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: #4f79ff;
      cursor: pointer;
      -webkit-appearance: none;
      margin-top: -3.6px;
    }
    input[type=range]:focus::-webkit-slider-runnable-track {
      background: #ccc;
    }
    input[type=range]::-moz-range-track {
      width: 100%;
      height: 10px;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      background: #ccc;
      border-radius: 25px;
      border: 0px solid #fafafa;
    }
    input[type=range]::-moz-range-thumb {
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      border: 0px solid #000000;
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: #4f79ff;
      cursor: pointer;
    }
    input[type=range]::-ms-track {
      height: 10px;
      cursor: pointer;
      background: transparent;
      border-color: transparent;
      border-width: 39px 0;
      color: transparent;
    }
    input[type=range]::-ms-fill-lower {
      background: #ccc;
      border: 0px solid #fafafa;
      border-radius: 50px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    input[type=range]::-ms-fill-upper {
      background: #ccc;
      border: 0px solid #fafafa;
      border-radius: 50px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    input[type=range]::-ms-thumb {
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      border: 0px solid #000000;
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: #4f79ff;
      cursor: pointer;
    }
    input[type=range]:focus::-ms-fill-lower {
      background: #ccc;
    }
    input[type=range]:focus::-ms-fill-upper {
      background: #ccc;
    }




    .sc-vote__btn {
      display: inline-block;
      border-radius: 50%;
      border: solid 4px #333;
      height: 30px;
      width: 30px;
      text-align: center;
      line-height: 26px;
      text-decoration: none;
    }

    .upvote-btn {
      display: block;
      margin-top: 20px;

    }

  </style>
  </head>
  <body>

    Hello world

    <section class="sc-section"></section>

    <script src="https://cdn.steemjs.com/lib/latest/steem.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>

    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>
    <script>
  console.log('hello')
    const CATEGORY = 'photofeed';
    const AUTHOR = 'sambillingham';
    const PERMLINK = '20180116t130531377z-post';
    const POSTTITLE = 'HELLO THIS IS THE TITLE';
    const STEEMSERVER = 'wss://rpc.buildteam.io';
    init()


    function init(){
        console.log('init')
        addTopBar()

        getComments()
    }

    function addTopBar(){
      let template = `
          <div class="sc-topbar">
            <span class="sc-topbar__date"></span>
            <span class="sc-topbar__upvote">Upvote</span>
            <span class="sc-topbar__reply">Reply<span>
          </div>
          <hr class="sc-topbar__rule">
      `

      $('.sc-section').append(template)
    }

    function addCommentTemplateAfter(dest) {
      let template = `<div class="modal__inner__comment">
        <input class="sc-comment__username" placeholder="username" type="text">
        <textarea class="sc-comment__message" placeholder="message"></textarea>
        <a href="#" target="_blank" class="sc-comment__btn">Comment</a>
        <span class="sc-close sc-comment__close" >&#43;</span>
      </div>`
      $(template).insertAfter(dest)
    }


    function addVoteTemplateAfter(dest){
      let template = `<div class="sc-vote">
            <input class="sc-vote__username" placeholder="username" type="text">
            <a href="#" target="_blank" class="sc-vote__btn">^</a>
            <span class="sc-vote__value">50%</span>
            <input type="range" min="1" max="100" value="50" class="sc-vote__slider" id="myRange">
            <span class="sc-close sc-vote__close" >&#43;</span>
          </div>`
      $(template).insertAfter(dest)
    }

    function setVoteUrl(username, author, permlink, weight){
      let steemconnectUrl = `https://v2.steemconnect.com/sign/vote?voter=${username}&author=${author}&permlink=${permlink}&weight=${weight}`
      $('.sc-vote__btn').attr('href', steemconnectUrl);
    }

    function setCommentUrl(parentAuthor,parentPermlink, author, message) {
      let title = 'RE: ' + POSTTITLE
      let permlink = randomString()
      let steemconnectUrl = encodeURI(`https://v2.steemconnect.com/sign/comment?parent_author=${parentAuthor}&parent_permlink=${parentPermlink}&author=${author}&permlink=${permlink}&title=${title}&body=${message}`)
      $('.sc-comment__btn').attr('href', steemconnectUrl)
    }

    function randomString() {
      let string = ''
      let allowedChars = "abcdefghijklmnopqrstuvwxyz0123456789";
      for (var i = 0; i < 32; i++){
        string += allowedChars.charAt(Math.floor(Math.random() * allowedChars.length));
      }
      return string;
  }


    $('.sc-topbar__upvote').on('click', () => {
      addVoteTemplateAfter('.sc-topbar__upvote')

    })

    $('.sc-topbar__reply').on('click', () => {
      addCommentTemplateAfter('.sc-section .sc-topbar__rule')
      $('.sc-vote').remove()
    })

    $('.sc-vote__username').on('keyup', (e) => {
      let username = $('.sc-vote__username').val().trim()
      let weight = $('.sc-vote__slider').val()
      let permlink = PERMLINK
      let author = AUTHOR
      setVoteUrl(username, author, permlink, weight)
    })

    $('.sc-vote__slider').on('input', (e) => {
      let username = $('.sc-vote__username').val().trim()
      let weight = $('.sc-vote__slider').val()
      let permlink = PERMLINK
      let author = AUTHOR
      $('.sc-vote__value').text(weight + '%')
      setVoteUrl(username, author, permlink, weight)
    })

    $('.sc-section').on('keyup', '.sc-comment__username',(e) => {
      console.log('user')
      let username = $('.sc-comment__username').val().trim()
      let message = $('.sc-comment__message').val()
      let parentPermlink = PERMLINK
      let parentAuthor = AUTHOR
      setCommentUrl(parentAuthor,parentPermlink, username, message)
    })
    $('.sc-section').on('keyup', '.sc-comment__message' , (e) => {
      let username = $('.sc-comment__username').val().trim()
      let message = $('.sc-comment__message').val()
      let parentPermlink = PERMLINK
      let parentAuthor = AUTHOR
      setCommentUrl(parentAuthor,parentPermlink, username, message)
    })

    $('.sc-section').on('click', '.sc-comment__close, .sc-vote__close', (e) => {
      $(e.currentTarget).parent().remove()
    });

    function getComments(){
        $('.sc-section').append('<div class="sc-comments"></div>')

        steem.api.setOptions({ url: STEEMSERVER });
        steem.api.getState(`/${CATEGORY}/@${AUTHOR}/${PERMLINK}`, function(err, result) {
            console.log(err, result);

            let resultsArray = [];

            for ( post in result.content ){

              var html = result.content[post].body

              resultsArray.push({
                  id: result.content[post].id,
                  title: result.content[post].title,
                  author: result.content[post].author,
                  body: html,
                  permlink: result.content[post].permlink,
                  depth: result.content[post].depth,
                  root_comment: result.content[post].root_comment,
                  parent_permlink: result.content[post].parent_permlink,
                  created: result.content[post].created
              })
            }

            resultsArray = resultsArray.sort((a,b) => {
                return b.id - a.id
            });

            resultsArray.forEach( (post, i, arr) => {
                var permlink = post.parent_permlink
                var metadata = JSON.parse(result.accounts[post.author].json_metadata).profile
                var  template = `
                <div data-post-id="${post.id}"  class="comment comment-level-${post.depth} ${post.permlink}">
                  <img src="${metadata.profile_image}" height="50" width="50">
                  <h4><a href="https://steemit.com/@${post.author}" target="_blank">${post.author}</a> &middot; ${ moment(post.created).fromNow() }</h4>
                  <p>${ post.body }...</p>
                </div>`
                if ( post.depth === 1 ) {
                  $('.sc-comments').prepend( template)
                }
            })

            resultsArray.forEach( (post, i, arr) => {
                var permlink = post.parent_permlink
                var metadata = JSON.parse(result.accounts[post.author].json_metadata).profile

                var  template = `
                <div data-post-id="${post.id}" class="comment comment-level-${post.depth} ${post.permlink}">
                  <img src="${metadata.profile_image}" height="50" width="50">
                  <h4><a href="https://steemit.com/@${post.author}" target="_blank">${post.author}</a> - ${ moment(post.created).fromNow() }</h4>

                  <p>${ post.body }...</p>
                </div>`
                if ( post.depth > 1 ) {
                  $('.' + permlink ).prepend( template)
                  console.log(permlink)
                  console.log( $('.' + permlink ))
                }
            })

        });
      }
    </script>
  </body>
</html>
