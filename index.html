<!doctype html>

<html>
  <head>
  <meta charset="utf8">
  <style>
    .comment {
      padding: 0 15px 10px;
    }
    .comment-level-1 {
      /*border: solid 1px red;*/
    }
    .comment-level-2 {
      /*border: solid 1px green;*/
      margin-left: 20px;
      /*padding: 0 15px 15px*/
    }
    img {
      border-radius: 50%;
      border: solid 2px #ccc;
    }
  </style>
  </head>
  <body>

    Hello world
    <script src="https://cdn.steemjs.com/lib/latest/steem.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>

    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>
    <script>
    let parent = 'sambillingham';
    let parentPermlink = '20180116t130531377z-post';

    steem.api.setOptions({ url: 'wss://rpc.buildteam.io' });


    // steem.api.getContentReplies(parent, parentPermlink, function (err, result) {
    //   console.log(err, result);
    // });

    steem.api.getState(`/photofeed/@${parent}/${parentPermlink}`, function(err, result) {
        console.log(err, result);

        let resultsArray = [];

        for ( post in result.content ){

          var html = result.content[post].body

          resultsArray.push({
              id: result.content[post].id,
              title: result.content[post].title,
              author: result.content[post].author,
              body: html,
              permlink: result.content[post].permlink,
              depth: result.content[post].depth,
              root_comment: result.content[post].root_comment,
              parent_permlink: result.content[post].parent_permlink,
              created: result.content[post].created
          })
        }

        resultsArray = resultsArray.sort((a,b) => {
            return b.id - a.id
        });

        resultsArray.forEach( (post, i, arr) => {
            var permlink = post.parent_permlink
            var metadata = JSON.parse(result.accounts[post.author].json_metadata).profile
            var  template = `
            <div data-post-id="${post.id}"  class="comment comment-level-${post.depth} ${post.permlink}">
              <img src="${metadata.profile_image}" height="50" width="50">
              <h4><a href="https://steemit.com/@${post.author}" target="_blank">${post.author}</a> - ${ moment(post.created).fromNow() }</h4>
              <p>${ post.body }...</p>
            </div>`
            if ( post.depth === 1 ) {
              $('body').prepend( template)
            }
        })

        resultsArray.forEach( (post, i, arr) => {
            var permlink = post.parent_permlink
            var metadata = JSON.parse(result.accounts[post.author].json_metadata).profile

            var  template = `
            <div data-post-id="${post.id}" class="comment comment-level-${post.depth} ${post.permlink}">
              <img src="${metadata.profile_image}" height="50" width="50">
              <h4><a href="https://steemit.com/@${post.author}" target="_blank">${post.author}</a> - ${ moment(post.created).fromNow() }</h4>

              <p>${ post.body }...</p>
            </div>`
            if ( post.depth > 1 ) {
              $('.' + permlink ).prepend( template)
              console.log(permlink)
              console.log( $('.' + permlink ))
            }
        })

    });
    </script>
  </body>
</html>
